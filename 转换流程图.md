# Labelme转COCO转换流程图

## 整体流程图

```
┌─────────────────────────────────────────────────────────────┐
│                   开始转换流程                                │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  步骤1: 初始化COCO字典结构                                    │
│  coco = {                                                    │
│    'categories': [],                                         │
│    'images': [],                                             │
│    'annotations': []                                         │
│  }                                                           │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  步骤2: 定义类别信息                                          │
│  categories = [{                                             │
│    'supercategory': 'sjb_rect',                              │
│    'id': 1,                                                  │
│    'name': 'sjb_rect',                                       │
│    'keypoints': ['angle_30', 'angle_60', 'angle_90'],       │
│    'skeleton': [[0,1], [0,2], [1,2]]                        │
│  }]                                                          │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  步骤3: 遍历所有Labelme JSON文件                              │
│  for labelme_json in os.listdir():                          │
│    if labelme_json.endswith('.json'):                       │
│      # 处理单个文件                                           │
└─────────────────────────────────────────────────────────────┘
                            ↓
        ┌───────────────────┴───────────────────┐
        │                                       │
        ↓                                       ↓
┌──────────────────────┐          ┌──────────────────────┐
│  提取图像信息          │          │  提取标注信息          │
│  images.append({      │          │  process_single_json │
│    'file_name': ...,  │          │                      │
│    'height': ...,     │          │                      │
│    'width': ...,      │          │                      │
│    'id': IMG_ID       │          │                      │
│  })                   │          │                      │
└──────────────────────┘          └──────────────────────┘
                                            ↓
                            ┌───────────────────────────────┐
                            │  process_single_json 函数详解   │
                            └───────────────────────────────┘
                                            ↓
┌─────────────────────────────────────────────────────────────┐
│  子步骤1: 遍历shapes，找到所有rectangle                       │
│  for each_ann in labelme['shapes']:                          │
│    if each_ann['shape_type'] == 'rectangle':                 │
│      # 开始处理这个矩形框                                      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  子步骤2: 计算边界框(bbox)                                    │
│  ┌─────────────────────────────────────┐                    │
│  │  Labelme: points = [[x1,y1], [x2,y2]]│                    │
│  │  (可能不是标准左上-右下格式)          │                    │
│  └─────────────────────────────────────┘                    │
│                    ↓                                         │
│  ┌─────────────────────────────────────┐                    │
│  │  计算:                               │                    │
│  │  left = min(x1, x2)                  │                    │
│  │  top = min(y1, y2)                   │                    │
│  │  right = max(x1, x2)                 │                    │
│  │  bottom = max(y1, y2)                │                    │
│  │  width = right - left                │                    │
│  │  height = bottom - top               │                    │
│  └─────────────────────────────────────┘                    │
│                    ↓                                         │
│  ┌─────────────────────────────────────┐                    │
│  │  COCO格式:                           │                    │
│  │  bbox = [left, top, width, height]   │                    │
│  │  area = width * height               │                    │
│  └─────────────────────────────────────┘                    │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  子步骤3: 匹配分割多边形(polygon)                             │
│  ┌─────────────────────────────────────┐                    │
│  │  遍历所有shapes，找到polygon类型       │                    │
│  │  for each_ann in labelme['shapes']:   │                    │
│  │    if shape_type == 'polygon':        │                    │
│  └─────────────────────────────────────┘                    │
│                    ↓                                         │
│  ┌─────────────────────────────────────┐                    │
│  │  空间匹配判断:                        │                    │
│  │  polygon的第一个点是否在rectangle内？ │                    │
│  │  if (first_x > bbox_left) &          │                    │
│  │     (first_x < bbox_right) &          │                    │
│  │     (first_y > bbox_top) &            │                    │
│  │     (first_y < bbox_bottom):          │                    │
│  │    # 匹配成功，提取segmentation        │                    │
│  └─────────────────────────────────────┘                    │
│                    ↓                                         │
│  ┌─────────────────────────────────────┐                    │
│  │  格式转换:                           │                    │
│  │  Labelme: [[x1,y1], [x2,y2], ...]    │                    │
│  │  COCO: [[x1, y1, x2, y2, ...]]       │                    │
│  │  (展平为一维数组，保留2位小数)         │                    │
│  └─────────────────────────────────────┘                    │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  子步骤4: 匹配关键点(point)                                   │
│  ┌─────────────────────────────────────┐                    │
│  │  遍历所有shapes，找到point类型        │                    │
│  │  for each_ann in labelme['shapes']:   │                    │
│  │    if shape_type == 'point':          │                    │
│  └─────────────────────────────────────┘                    │
│                    ↓                                         │
│  ┌─────────────────────────────────────┐                    │
│  │  空间匹配判断:                        │                    │
│  │  关键点坐标是否在rectangle内？        │                    │
│  │  if (x > bbox_left) & (x < bbox_right)│                    │
│  │     & (y > bbox_top) & (y < bbox_bottom)│                   │
│  │    # 匹配成功，存储到字典              │                    │
│  │    bbox_keypoints_dict[label] = [x,y] │                    │
│  └─────────────────────────────────────┘                    │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  子步骤5: 按类别顺序排列关键点                                │
│  ┌─────────────────────────────────────┐                    │
│  │  按照categories中定义的顺序:          │                    │
│  │  ['angle_30', 'angle_60', 'angle_90']│                    │
│  └─────────────────────────────────────┘                    │
│                    ↓                                         │
│  ┌─────────────────────────────────────┐                    │
│  │  for each_class in keypoints:        │                    │
│  │    if each_class in dict:            │                    │
│  │      keypoints.append(x)             │                    │
│  │      keypoints.append(y)             │                    │
│  │      keypoints.append(2)  # 可见性    │                    │
│  │    else:                             │                    │
│  │      keypoints.append(0)             │                    │
│  │      keypoints.append(0)             │                    │
│  │      keypoints.append(0)             │                    │
│  └─────────────────────────────────────┘                    │
│                    ↓                                         │
│  ┌─────────────────────────────────────┐                    │
│  │  最终格式:                           │                    │
│  │  [x1, y1, v1, x2, y2, v2, ...]       │                    │
│  │  每3个数字一组: [x坐标, y坐标, 可见性] │                    │
│  └─────────────────────────────────────┘                    │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  子步骤6: 组装annotation                                     │
│  annotation = {                                              │
│    'id': ANN_ID,                                             │
│    'image_id': image_id,                                     │
│    'category_id': 1,                                         │
│    'bbox': [x, y, w, h],                                     │
│    'area': area,                                             │
│    'iscrowd': 0,                                             │
│    'segmentation': [...],                                    │
│    'num_keypoints': count,                                   │
│    'keypoints': [x1, y1, v1, ...]                            │
│  }                                                           │
│  ANN_ID += 1                                                 │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  步骤4: 保存为COCO格式JSON文件                                │
│  with open('output_coco/coco_sample.json', 'w') as f:        │
│    json.dump(coco, f, indent=2)                              │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    转换完成                                   │
└─────────────────────────────────────────────────────────────┘
```

## 数据流转换图

```
Labelme格式                          COCO格式
─────────────────                  ─────────────────
                                   
imagePath        ────────────────→ file_name
imageHeight      ────────────────→ height
imageWidth       ────────────────→ width
                                   
shapes[]:                           
  rectangle      ────────────────→ annotations[].bbox
  polygon        ────────────────→ annotations[].segmentation
  point[]        ────────────────→ annotations[].keypoints
                                   
                                   
categories定义:                     
  keypoints顺序  ────────────────→ categories[].keypoints
  skeleton      ────────────────→ categories[].skeleton
```

## 关键点匹配逻辑图

```
┌─────────────────────────────────────────────────────────┐
│  Labelme shapes数组                                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │rectangle │  │ polygon  │  │  point   │            │
│  │[100,100] │  │[110,110] │  │[150,120] │            │
│  │[200,200] │  │[190,190] │  │label:    │            │
│  │          │  │          │  │angle_30  │            │
│  └──────────┘  └──────────┘  └──────────┘            │
└─────────────────────────────────────────────────────────┘
         │              │              │
         │              │              │
         ▼              ▼              ▼
┌─────────────────────────────────────────────────────────┐
│  空间匹配判断                                             │
│  ┌──────────────────────────────────────┐              │
│  │  polygon第一个点在rectangle内？        │              │
│  │  point坐标在rectangle内？             │              │
│  └──────────────────────────────────────┘              │
└─────────────────────────────────────────────────────────┘
         │              │              │
         │              │              │
         ▼              ▼              ▼
┌─────────────────────────────────────────────────────────┐
│  组装COCO annotation                                     │
│  ┌──────────────────────────────────────┐              │
│  │  bbox: [100, 100, 100, 100]          │              │
│  │  segmentation: [[110,110,190,190]]   │              │
│  │  keypoints: [150,120,2, ...]         │              │
│  └──────────────────────────────────────┘              │
└─────────────────────────────────────────────────────────┘
```

## 关键点顺序排列示例

```
categories定义:
  keypoints = ['angle_30', 'angle_60', 'angle_90']
  
Labelme中的关键点:
  angle_60: [150, 150]
  angle_30: [120, 120]
  angle_90: [180, 180]
  
匹配后的字典:
  bbox_keypoints_dict = {
    'angle_30': [120, 120],
    'angle_60': [150, 150],
    'angle_90': [180, 180]
  }
  
按顺序排列后的COCO格式:
  keypoints = [
    120, 120, 2,  # angle_30
    150, 150, 2,  # angle_60
    180, 180, 2   # angle_90
  ]
```

