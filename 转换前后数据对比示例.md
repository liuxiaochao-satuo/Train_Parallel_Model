# Labelme转COCO转换前后数据对比示例

## 完整示例

### 输入：Labelme格式（单个JSON文件）

```json
{
  "version": "4.5.6",
  "flags": {},
  "imagePath": "DSC_0281.jpg",
  "imageData": "iVBORw0KGgoAAAANSUhEUgAA...",
  "imageHeight": 480,
  "imageWidth": 640,
  "shapes": [
    {
      "label": "sjb_rect",
      "points": [
        [120.5, 100.3],
        [220.8, 200.7]
      ],
      "group_id": null,
      "shape_type": "rectangle",
      "flags": {}
    },
    {
      "label": "polygon",
      "points": [
        [130.2, 110.5],
        [210.3, 110.8],
        [210.6, 190.2],
        [130.1, 190.5]
      ],
      "group_id": null,
      "shape_type": "polygon",
      "flags": {}
    },
    {
      "label": "angle_30",
      "points": [
        [150.0, 120.0]
      ],
      "group_id": null,
      "shape_type": "point",
      "flags": {}
    },
    {
      "label": "angle_60",
      "points": [
        [150.0, 150.0]
      ],
      "group_id": null,
      "shape_type": "point",
      "flags": {}
    },
    {
      "label": "angle_90",
      "points": [
        [180.0, 180.0]
      ],
      "group_id": null,
      "shape_type": "point",
      "flags": {}
    }
  ]
}
```

### 输出：COCO格式（合并后的JSON文件）

```json
{
  "info": {},
  "licenses": [],
  "categories": [
    {
      "supercategory": "sjb_rect",
      "id": 1,
      "name": "sjb_rect",
      "keypoints": [
        "angle_30",
        "angle_60",
        "angle_90"
      ],
      "skeleton": [
        [0, 1],
        [0, 2],
        [1, 2]
      ]
    }
  ],
  "images": [
    {
      "file_name": "DSC_0281.jpg",
      "height": 480,
      "width": 640,
      "id": 0
    }
  ],
  "annotations": [
    {
      "id": 0,
      "image_id": 0,
      "category_id": 1,
      "bbox": [
        120,
        100,
        100,
        100
      ],
      "area": 10000,
      "iscrowd": 0,
      "segmentation": [
        [
          130.2,
          110.5,
          210.3,
          110.8,
          210.6,
          190.2,
          130.1,
          190.5
        ]
      ],
      "num_keypoints": 3,
      "keypoints": [
        150,
        120,
        2,
        150,
        150,
        2,
        180,
        180,
        2
      ]
    }
  ]
}
```

---

## 字段映射详解

### 1. 图像信息映射

| Labelme字段 | 值 | COCO字段 | 值 | 说明 |
|------------|-----|---------|-----|------|
| `imagePath` | "DSC_0281.jpg" | `file_name` | "DSC_0281.jpg" | 图像文件名 |
| `imageHeight` | 480 | `height` | 480 | 图像高度（像素） |
| `imageWidth` | 640 | `width` | 640 | 图像宽度（像素） |
| - | - | `id` | 0 | 图像ID（自动生成） |

### 2. 边界框（bbox）转换

#### Labelme格式
```json
{
  "shape_type": "rectangle",
  "points": [
    [120.5, 100.3],  // 点1
    [220.8, 200.7]   // 点2
  ]
}
```

#### 转换过程
```python
# 步骤1：提取坐标
point1 = [120.5, 100.3]
point2 = [220.8, 200.7]

# 步骤2：计算边界
left = min(120.5, 220.8) = 120.5 → 120 (取整)
top = min(100.3, 200.7) = 100.3 → 100 (取整)
right = max(120.5, 220.8) = 220.8 → 220 (取整)
bottom = max(100.3, 200.7) = 200.7 → 200 (取整)

# 步骤3：计算宽高
width = 220 - 120 = 100
height = 200 - 100 = 100

# 步骤4：COCO格式
bbox = [120, 100, 100, 100]  // [左上x, 左上y, 宽度, 高度]
area = 100 * 100 = 10000
```

#### COCO格式
```json
{
  "bbox": [120, 100, 100, 100],
  "area": 10000
}
```

### 3. 分割掩码（segmentation）转换

#### Labelme格式
```json
{
  "shape_type": "polygon",
  "points": [
    [130.2, 110.5],
    [210.3, 110.8],
    [210.6, 190.2],
    [130.1, 190.5]
  ]
}
```

#### 转换过程
```python
# Labelme格式：二维数组
# [[x1, y1], [x2, y2], [x3, y3], [x4, y4]]

# COCO格式：一维数组（展平）
# [x1, y1, x2, y2, x3, y3, x4, y4]

# 保留两位小数
segmentation = [
  130.2, 110.5,  # 点1
  210.3, 110.8,  # 点2
  210.6, 190.2,  # 点3
  130.1, 190.5   # 点4
]
```

#### COCO格式
```json
{
  "segmentation": [
    [
      130.2,
      110.5,
      210.3,
      110.8,
      210.6,
      190.2,
      130.1,
      190.5
    ]
  ]
}
```

**注意**：COCO的segmentation是嵌套数组，外层数组可以包含多个多边形（用于复杂分割）。

### 4. 关键点（keypoints）转换

#### Labelme格式
```json
[
  {
    "label": "angle_30",
    "shape_type": "point",
    "points": [[150.0, 120.0]]
  },
  {
    "label": "angle_60",
    "shape_type": "point",
    "points": [[150.0, 150.0]]
  },
  {
    "label": "angle_90",
    "shape_type": "point",
    "points": [[180.0, 180.0]]
  }
]
```

#### 转换过程

**步骤1：空间匹配**
```python
# 判断每个关键点是否在rectangle内部
# rectangle: [120, 100, 100, 100]  # [x, y, w, h]
# 边界：x ∈ [120, 220], y ∈ [100, 200]

angle_30: [150, 120] → 在内部 ✓
angle_60: [150, 150] → 在内部 ✓
angle_90: [180, 180] → 在内部 ✓
```

**步骤2：存储到字典**
```python
bbox_keypoints_dict = {
    'angle_30': [150, 120],
    'angle_60': [150, 150],
    'angle_90': [180, 180]
}
```

**步骤3：按顺序排列**
```python
# categories中定义的顺序：['angle_30', 'angle_60', 'angle_90']
keypoints = []

# angle_30
keypoints.append(150)  # x
keypoints.append(120)  # y
keypoints.append(2)    # 可见性

# angle_60
keypoints.append(150)  # x
keypoints.append(150)  # y
keypoints.append(2)    # 可见性

# angle_90
keypoints.append(180)  # x
keypoints.append(180)  # y
keypoints.append(2)    # 可见性

# 最终结果
keypoints = [150, 120, 2, 150, 150, 2, 180, 180, 2]
```

#### COCO格式
```json
{
  "num_keypoints": 3,
  "keypoints": [
    150, 120, 2,  // angle_30: [x, y, visibility]
    150, 150, 2,  // angle_60: [x, y, visibility]
    180, 180, 2   // angle_90: [x, y, visibility]
  ]
}
```

---

## 特殊情况处理

### 情况1：缺少某些关键点

假设只有`angle_30`和`angle_60`，缺少`angle_90`：

#### Labelme格式
```json
{
  "label": "angle_30",
  "points": [[150.0, 120.0]]
},
{
  "label": "angle_60",
  "points": [[150.0, 150.0]]
}
```

#### COCO格式
```json
{
  "num_keypoints": 2,
  "keypoints": [
    150, 120, 2,  // angle_30: 存在
    150, 150, 2,  // angle_60: 存在
    0, 0, 0       // angle_90: 不存在，填充0
  ]
}
```

### 情况2：多个目标对象

假设图像中有两个目标对象：

#### Labelme格式
```json
{
  "shapes": [
    {
      "shape_type": "rectangle",
      "points": [[100, 100], [200, 200]]
    },
    {
      "shape_type": "point",
      "label": "angle_30",
      "points": [[150, 120]]
    },
    {
      "shape_type": "rectangle",
      "points": [[300, 300], [400, 400]]
    },
    {
      "shape_type": "point",
      "label": "angle_30",
      "points": [[350, 320]]
    }
  ]
}
```

#### COCO格式
```json
{
  "annotations": [
    {
      "id": 0,
      "image_id": 0,
      "bbox": [100, 100, 100, 100],
      "keypoints": [150, 120, 2, 0, 0, 0, 0, 0, 0]
    },
    {
      "id": 1,
      "image_id": 0,
      "bbox": [300, 300, 100, 100],
      "keypoints": [350, 320, 2, 0, 0, 0, 0, 0, 0]
    }
  ]
}
```

**关键点**：每个rectangle生成一个独立的annotation，关键点通过空间位置匹配到对应的rectangle。

### 情况3：没有分割掩码

如果某个rectangle没有对应的polygon：

#### COCO格式
```json
{
  "segmentation": [],  // 空数组
  "bbox": [100, 100, 100, 100]
}
```

---

## 数据验证要点

1. **关键点顺序**：必须与`categories[].keypoints`定义的顺序一致
2. **关键点格式**：每3个数字一组 `[x, y, visibility]`
3. **bbox格式**：`[左上x, 左上y, 宽度, 高度]`
4. **segmentation格式**：一维数组，坐标保留两位小数
5. **ID唯一性**：每个image和annotation的ID必须唯一

---

## 常见错误示例

### ❌ 错误1：关键点顺序不对

```json
// categories定义：['angle_30', 'angle_60', 'angle_90']
// 但keypoints中顺序错误
{
  "keypoints": [
    180, 180, 2,  // angle_90 应该在最后
    150, 120, 2,  // angle_30
    150, 150, 2   // angle_60
  ]
}
```

### ❌ 错误2：关键点格式不对

```json
// 缺少可见性标志
{
  "keypoints": [150, 120, 150, 150]  // 应该是 [150, 120, 2, 150, 150, 2]
}
```

### ❌ 错误3：bbox格式不对

```json
// 使用了中心点+宽高格式（YOLO格式）
{
  "bbox": [160, 150, 100, 100]  // 应该是 [120, 100, 100, 100]
}
```

### ✅ 正确格式

```json
{
  "keypoints": [150, 120, 2, 150, 150, 2, 180, 180, 2],
  "bbox": [120, 100, 100, 100]
}
```

