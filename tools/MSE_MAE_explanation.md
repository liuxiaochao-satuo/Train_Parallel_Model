# MSE 和 MAE 指标说明

## 指标含义

### MSE (Mean Squared Error) - 均方误差

**定义：**
```
MSE = mean((img1 - img2)²)
```

**含义：**
- 衡量两张图片像素差异的**平方平均值**
- 对**大差异**更敏感（因为平方运算放大了大差异）
- 单位：像素值的平方

**对于 uint8 图像（像素值 0-255）的参考标准：**
- **MSE < 1.0**：几乎无差异（理想情况）
- **MSE < 10.0**：差异很小（可接受）
- **MSE < 100.0**：差异中等（可能有轻微压缩损失）
- **MSE > 100.0**：差异较大（明显质量损失）
- **MSE > 1000.0**：差异很大（严重质量损失）

### MAE (Mean Absolute Error) - 平均绝对误差

**定义：**
```
MAE = mean(|img1 - img2|)
```

**含义：**
- 衡量两张图片像素差异的**平均值**
- 对所有差异**同等对待**（不像MSE那样放大大差异）
- 单位：像素值

**对于 uint8 图像（像素值 0-255）的参考标准：**
- **MAE < 0.1**：几乎无差异（理想情况）
- **MAE < 1.0**：差异很小（可接受）
- **MAE < 2.0**：差异中等（可能有轻微压缩损失）
- **MAE > 5.0**：差异较大（明显质量损失）
- **MAE > 10.0**：差异很大（严重质量损失）

## 你的诊断结果分析

从你的输出看：
```
MSE: 1525.34  (很大！)
MAE: 22.13    (很大！)
max_diff: 190.0
pixel_diff_ratio: 0.793 (79.3%的像素都有差异)
```

**结论：**
- 差异**非常大**，说明 JPEG 压缩（质量95）导致了明显的质量损失
- 79.3% 的像素都发生了变化
- 最大差异达到 190（接近 255 的最大值）

## 如何减少差异

### 方案1：使用 PNG 格式（推荐）⭐

**优点：**
- **完全无损**，MSE 和 MAE 接近 0
- 不会引入压缩伪影
- 推理结果与直接使用数组完全一致

**缺点：**
- 文件大小较大（约 5-10 倍于 JPEG）
- I/O 速度稍慢

**实现：**
在视频推理脚本中使用 PNG 格式保存临时文件：
```python
temp_img_path = temp_dir / f"frame_{frame_count:06d}.png"  # 改为 .png
cv2.imwrite(str(temp_img_path), frame)  # PNG默认无损
```

### 方案2：提高 JPEG 质量

**当前：** JPEG 质量 95
**建议：** JPEG 质量 100（最高质量）

**实现：**
```python
cv2.imwrite(str(temp_img_path), frame, [cv2.IMWRITE_JPEG_QUALITY, 100])
```

**效果：**
- MSE 可能降到 100-500 范围
- MAE 可能降到 5-15 范围
- 文件大小增加约 20-30%
- **仍然有损失，但比质量95好很多**

### 方案3：直接使用视频帧（不保存文件）

**如果视频质量足够好：**
- 直接使用 `cv2.VideoCapture.read()` 读取的帧
- 不经过文件保存/读取步骤
- 避免额外的压缩损失

**但问题：**
- 视频帧本身可能已经经过压缩（H.264/H.265）
- 这是导致视频推理效果差的根本原因

## 推荐方案

**最佳方案：使用 PNG 格式的临时文件**

1. **质量保证：** 完全无损，推理结果与图片推理一致
2. **性能权衡：** 虽然文件大、I/O慢，但推理质量最重要
3. **实现简单：** 只需修改文件扩展名

**如果必须使用 JPEG：**
- 至少使用质量 100
- 接受仍有轻微损失的事实

## 实际建议

根据你的诊断结果（MSE=1525，MAE=22），**强烈建议使用 PNG 格式**，因为：
1. 差异太大，JPEG 压缩损失明显
2. 这很可能是导致视频推理效果差的主要原因
3. PNG 虽然慢一些，但能保证推理质量

