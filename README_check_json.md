# Labelme标注文件检查工具

## 功能说明

这个工具用于检查使用Labelme标注的骨骼关键点检测数据集，确保标注文件符合训练要求。

## 标注规则

### 关键点定义
- **标准COCO 17个关键点** + **新增4个关键点** = **总共21个关键点**
- 每个关键点必须按照标准顺序排列

### 关键点顺序（共21个）

```
0.  nose              (鼻子)
1.  left_eye          (左眼)
2.  right_eye         (右眼)
3.  left_ear          (左耳)
4.  right_ear         (右耳)
5.  left_shoulder     (左肩)
6.  right_shoulder    (右肩)
7.  left_elbow        (左肘)
8.  right_elbow       (右肘)
9.  left_wrist        (左腕)
10. right_wrist       (右腕)
11. left_hip          (左髋)
12. right_hip         (右髋)
13. left_knee         (左膝)
14. right_knee        (右膝)
15. left_ankle        (左踝)
16. right_ankle       (右踝)
17. left_heel         (左脚底) [新增]
18. right_heel        (右脚底) [新增]
19. left_foot         (左脚面) [新增]
20. right_foot        (右脚面) [新增]
```

### 标注规则

1. **group_id规则**
   - `group_id` 代表人物信息
   - 每个 `group_id` 代表一个人
   - 每个 `group_id` 必须包含完整的21个关键点

2. **关键点顺序**
   - 每个 `group_id` 内的关键点必须按照上述标准顺序排列
   - 不能缺少任何关键点
   - 不能有重复的关键点标签

3. **可见性（description字段）**
   - `0`: 完全遮挡（关键点不可见）
   - `1`: 遮挡可推测（关键点被遮挡但可以推测位置）
   - `2`: 清晰可见（关键点清晰可见）
   - description值必须是字符串 "0"、"1" 或 "2"

## 检查内容

工具会检查以下内容：

### 错误检查（Errors）
1. ✅ JSON文件格式是否正确
2. ✅ 必需字段是否存在（version, shapes, imagePath等）
3. ✅ 每个group_id是否包含21个关键点
4. ✅ 关键点标签是否完整（不缺少任何标准关键点）
5. ✅ 是否有重复的关键点标签（同一group_id内）
6. ✅ 是否有未知的关键点标签
7. ✅ 可见性值是否有效（0、1、2）
8. ✅ 坐标格式是否正确

### 警告检查（Warnings）
1. ⚠️ 关键点顺序是否正确
2. ⚠️ 坐标是否在图像范围内
3. ⚠️ shape_type是否为"point"

## 使用方法

### 检查单个文件

```bash
python check_json.py <json_file>
```

示例：
```bash
python check_json.py 000000000000.json
```

### 检查目录中的所有JSON文件

```bash
python check_json.py <directory>
```

示例：
```bash
python check_json.py ./annotations/
```

### 递归检查目录（包括子目录）

```bash
python check_json.py <directory> --recursive
# 或
python check_json.py <directory> -r
```

## 输出说明

### 成功示例
```
============================================================
检查文件: 000000000000.json
============================================================
✓ 检查通过！没有发现错误或警告。
```

### 有错误的示例
```
============================================================
检查文件: example.json
============================================================

❌ 发现 2 个错误:
  1. group_id=1 的关键点数量错误: 期望 21 个，实际 20 个
  2. group_id=1 缺少关键点: left_foot (索引 19)

⚠️  发现 1 个警告:
  1. 关键点 left_heel (group_id=1) 坐标 (1650.5, 850.2) 超出图像范围 (1600x1200)
```

### 批量检查总结
```
============================================================
检查总结
============================================================
总文件数: 100
通过: 95
失败: 5
总错误数: 12
总警告数: 8
```

## 常见问题

### Q: 如果关键点顺序不对会怎样？
A: 工具会显示警告，但不会阻止转换。建议按照标准顺序排列，以便后续转换为COCO格式时保持一致。

### Q: 如果某个关键点完全被遮挡怎么办？
A: 仍然需要标注该关键点，但将 `description` 设置为 "0"（完全遮挡）。坐标可以标注在推测位置。

### Q: 可以跳过某些关键点吗？
A: 不可以。每个group_id必须包含完整的21个关键点，即使某些关键点被遮挡。

### Q: 如何修复检查出的错误？
A: 
1. 打开Labelme重新编辑标注文件
2. 确保每个group_id有21个关键点
3. 按照标准顺序排列关键点
4. 检查可见性值是否正确
5. 重新运行检查工具验证

## 下一步

检查通过后，可以使用相应的转换脚本将Labelme格式转换为COCO格式进行训练。

